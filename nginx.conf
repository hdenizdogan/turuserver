events {}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout 65;

    # Improve proxy behavior
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Map hostnames to container:port pairs
    map $host $target_upstream {
        default                             "";
        jellyfin.server.local               jellyfin:8096;
        prowlarr.server.local               prowlarr:9696;
        sonarr.server.local                 sonarr:8989;
        radarr.server.local                 radarr:7878;
        bazarr.server.local                 bazarr:6767;
        qbittorrent.server.local            qbittorrent:8090;
        jellyseerr.server.local             jellyseerr:5055;
        portainer.server.local              portainer:9000;
        homeassistant.server.local          homeassistant:8123;
        cockpit.server.local                host.docker.internal:9090;
    }

    # Dynamic proxy based on server_name
    server {
        listen 80;
        server_name ~^(?<subdomain>.+)\.server\.local$;

        location / {
            # Only proxy if mapping exists
            if ($target_upstream = "") {
                return 404;
            }

            proxy_pass http://$target_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }

    # Optional: Default catch-all server for unmatched requests
    server {
        listen 80 default_server;
        return 444;
    }
}
