# ğŸ³ Media & Home Server Docker Stack

This repository contains a **production-ready Docker Compose stack** for a self-hosted media server and supporting services.  
It is designed for **remote access via Tailscale Funnel**, **manual TLS via Caddy**, and **hardware-accelerated media workloads**.

The stack is optimized for:
- Jellyfin-based media streaming
- Automated media management (Sonarr / Radarr / Lidarr / Bazarr)
- Torrenting (qBittorrent)
- Media optimization (Unmanic)
- Request management (Jellyseerr)
- Statistics & monitoring (Jellystat, Dashdot)
- Photo management (Immich)
- Secure remote access without port-forwarding

---

## âœ¨ Key Features

- **Tailscale Funnel exposure** via `tsdproxy`
- **Manual TLS termination** using Caddy + Funnel-issued certificates
- **Hardware acceleration** (Intel iGPU / VAAPI / OpenVINO)
- **Single bridge network** with fixed subnet
- **Host networking for Jellyfin** (DLNA & discovery)
- **Watchtower auto-updates**
- **Modular & extensible** (many services commented and ready)

---

## ğŸ§± Architecture Overview

This stack has **two completely separate access paths**:

- **Local access (LAN / Tailscale LAN)** â†’ via **Caddy**
- **Public access (Internet)** â†’ via **Tailscale Funnel (tsdproxy)**

Caddy is **not** in the public access path.  
Tailscale Funnel is **not** in the local access path.

---

### ğŸŒ Public Access (Internet â†’ Services)


```
Internet
   â”‚
   â–¼
Tailscale Funnel
   â”‚
   â–¼
tsdproxy
   â”‚
   â–¼
Docker Services
```

- `tsdproxy` exposes selected containers directly via **Tailscale Funnel**
- Each service is published using Docker labels
- TLS and authentication are handled **entirely by Tailscale**
- **Caddy is NOT used**
- No reverse proxy, no ACME, no port-forwarding

âœ… Secure public access  
âœ… Zero open ports  
âœ… Identity-aware access via Tailscale

---

### ğŸ  Local Access (LAN / Internal Network)

```
Client (LAN / VPN)
â”‚
â–¼
Caddy
â”‚
â–¼
Docker Services
```


- Caddy acts as a **local reverse proxy**
- Uses **manual TLS certificates** mounted from `tsdproxy`
- Certificates are reused only for **local HTTPS**
- Services are accessed via:

```
https://service.<domain>
```


- Traffic never leaves the local network

âœ… Clean local HTTPS  
âœ… Central routing  
âœ… No dependency on Tailscale for local access

---

### ğŸ” Certificate Flow (Important)


```
Tailscale Funnel
â”‚
â–¼
tsdproxy
â”‚
â”œâ”€â”€ Issues & renews certificates
â”‚
â–¼
/mnt/docker/tsdproxy/data/default/<service>/certs
â”‚
â–¼
Caddy (read-only)
```

- Certificates are **issued once by Tailscale**
- Caddy only **consumes** them
- Caddy never requests or renews certificates itself

---

### ğŸš« What Does NOT Happen

- âŒ Public traffic does NOT go through Caddy
- âŒ Local traffic does NOT go through tsdproxy
- âŒ No ports are forwarded from the router
- âŒ No ACME challenges from Caddy

---

### ğŸ§  Why This Design?

- Avoids double TLS termination
- Prevents ACME conflicts
- Keeps public exposure minimal
- Allows full local control with HTTPS
- Makes Funnel purely â€œedge-facingâ€

---

## ğŸ“¦ Included Services

### ğŸ¬ Media & Automation
- **Jellyfin** â€“ Media server (host networking)
- **Sonarr / Radarr / Lidarr** â€“ Media automation
- **Bazarr** â€“ Subtitle management
- **Prowlarr** â€“ Indexer manager
- **qBittorrent** â€“ Torrent client
- **Unmanic** â€“ Media optimization & remuxing
- **Jellyseerr** â€“ Media requests

### ğŸ“Š Monitoring & Stats
- **Jellystat** + PostgreSQL â€“ Jellyfin analytics
- **Dashdot** â€“ System metrics dashboard

### ğŸ“· Photos
- **Immich** â€“ Self-hosted photo backup
- **Immich Machine Learning** â€“ OpenVINO accelerated ML
- **Redis & PostgreSQL** â€“ Immich backend services

### ğŸ”§ Infrastructure
- **Caddy** â€“ Reverse proxy & TLS
- **tsdproxy** â€“ Tailscale Funnel automation
- **Watchtower** â€“ Automatic container updates
- **Portainer** â€“ Docker management UI
- **Meilisearch** â€“ Search backend (optional)

---

## ğŸŒ Domains & Routing

All services are exposed as subdomains:

```
https://jellyfin.example.com
https://sonarr.example.com
https://radarr.example.com
https://immich.example.com
...
```

Routing is handled by **Caddy** using **manual TLS certificates** generated by **Tailscale Funnel**.

---

## ğŸ” TLS & Security Model

- `auto_https off` in Caddy
- TLS certificates are **not issued by Caddy**
- Certificates are mounted from:
  ```
  /mnt/docker/tsdproxy/data/default/<service>/certs/
  ```
- Authentication & access control handled by **Tailscale**
- Services are private unless explicitly exposed

---

## ğŸ“ Directory Layout

```
/mnt/docker/
â”œâ”€â”€ jellyfin_config
â”œâ”€â”€ jellyfin_cache
â”œâ”€â”€ sonarr
â”œâ”€â”€ radarr
â”œâ”€â”€ lidarr
â”œâ”€â”€ bazarr
â”œâ”€â”€ qbittorrent
â”œâ”€â”€ unmanic
â”œâ”€â”€ jellystat-db
â”œâ”€â”€ immich
â”œâ”€â”€ redis
â”œâ”€â”€ tsdproxy
â”œâ”€â”€ portainer_data
â””â”€â”€ watchtower
```

Media storage:
```
/mnt/media/
â”œâ”€â”€ Movies
â”œâ”€â”€ Shows
â”œâ”€â”€ Music
â””â”€â”€ torrent
```

---

## âš™ï¸ Requirements

- Docker & Docker Compose
- Tailscale account
- Tailscale Funnel enabled
- Intel iGPU recommended (VAAPI / OpenVINO)
- Linux host (mini PC / server)

---

## ğŸ§ª Environment Variables

Create a `.env` file:

```env
DOMAIN=example.com
TZ=Europe/Istanbul

PUID=1000
PGID=1000

# Tailscale
TSFUNNEL_AUTHKEY=tskey-xxxx

# Jellystat
JELLYSTATDB_POSTGRES_USER=jellystat
JELLYSTATDB_POSTGRES_PASSWORD=securepassword
JELLYSTATDB_POSTGRES_IP=jellystat-db
JELLYSTATDB_POSTGRES_PORT=5432
JELLYSTAT_JWT_SECRET=supersecret

# Immich
UPLOAD_LOCATION=/mnt/media/photos
DB_DATA_LOCATION=/mnt/docker/immich_postgres
DB_USERNAME=immich
DB_PASSWORD=immichpassword
DB_DATABASE_NAME=immich
IMMICH_VERSION=release

# Watchtower (optional)
WATCHTOWER_NOTIFICATION_URL=
HOSTNAME=homeserver
```

You can also check the `mock.env` for further additional variables.

---

## ğŸš€ Deployment

```bash
docker compose pull
docker compose up -d
```

Check status:
```bash
docker compose ps
```

---

## ğŸ§  Design Decisions

### Why Jellyfin uses `network_mode: host`?
- DLNA & auto-discovery support
- Better performance
- Avoids multicast issues

### Why Caddy with manual TLS?
- Funnel already provides valid certificates
- Avoids ACME conflicts
- Simple and predictable TLS handling

### Why tsdproxy?
- Automatic Funnel exposure using Docker labels
- No manual `tailscale serve` commands
- Clean Docker-native workflow

---

## ğŸ§© Optional / Commented Services

Pre-configured but disabled services include:
- Homarr
- Glances
- Home Assistant
- Stirling PDF
- Wizarr
- Jellysweep
- Filebrowser
- Nginx Proxy Manager
- AdGuard Home

Uncomment and configure as needed.

---

## âš ï¸ Notes

- This setup assumes **trusted Tailscale users**
- Funnel exposure is public but gated by Tailscale auth
- Regularly back up `/mnt/docker`
- Monitor disk usage (Immich & Unmanic can grow fast)

---

## ğŸ“œ License

Provided as-is for personal and educational use.

---

## ğŸ™Œ Credits

- Jellyfin & *Arr ecosystem
- LinuxServer.io
- Immich team
- Tailscale & tsdproxy
- Caddy Web Server
